<?php

use App\Actions\Documents\GetDocumentStatus;
use App\Models\Campaign;
use App\Models\Document;
use App\Models\DocumentJob;
use App\Models\Processor;
use App\Models\ProcessorExecution;
use App\Tenancy\TenantContext;
use Tests\Support\UsesDashboardSetup;

uses(UsesDashboardSetup::class)
    ->group('feature', 'document', 'action', 'tenant');

describe('GetDocumentStatus Action', function () {
    beforeEach(function () {
        // Setup tenant with database
        [$tenant, $user] = $this->setupDashboardTestTenant();
        $this->tenant = $tenant;
        $this->user = $user;
    });

    test('retrieves document with relationships loaded', function () {
        TenantContext::run($this->tenant, function () {
            $campaign = Campaign::factory()->create();
            $document = Document::factory()
                ->for($campaign)
                ->create();

            $action = new GetDocumentStatus;
            $result = $action->handle($document);

            expect($result)->toBeInstanceOf(Document::class)
                ->and($result->id)->toBe($document->id)
                ->and($result->relationLoaded('campaign'))->toBeTrue();
        });
    });

    test('eager loads campaign relationship', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->relationLoaded('campaign'))->toBeTrue()
            ->and($result->campaign)->not->toBeNull()
            ->and($result->campaign->id)->toBe($this->campaign->id);
    });

    test('eager loads document job relationship', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $documentJob = DocumentJob::factory()
            ->for($document)
            ->for($this->campaign)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->relationLoaded('documentJob'))->toBeTrue()
            ->and($result->documentJob)->not->toBeNull()
            ->and($result->documentJob->id)->toBe($documentJob->id);
    });

    test('eager loads processor executions with processors', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $documentJob = DocumentJob::factory()
            ->for($document)
            ->for($this->campaign)
            ->create();

        $processor = Processor::factory()->create(['slug' => 'ocr-processor']);

        $execution = ProcessorExecution::factory()
            ->for($documentJob)
            ->for($processor)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->documentJob->relationLoaded('processorExecutions'))->toBeTrue()
            ->and($result->documentJob->processorExecutions)->toHaveCount(1)
            ->and($result->documentJob->processorExecutions->first()->relationLoaded('processor'))->toBeTrue()
            ->and($result->documentJob->processorExecutions->first()->processor->slug)->toBe('ocr-processor');
    });

    test('handles document without job gracefully', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->relationLoaded('documentJob'))->toBeTrue()
            ->and($result->documentJob)->toBeNull();
    });

    test('handles document job without executions', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $documentJob = DocumentJob::factory()
            ->for($document)
            ->for($this->campaign)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->documentJob)->not->toBeNull()
            ->and($result->documentJob->relationLoaded('processorExecutions'))->toBeTrue()
            ->and($result->documentJob->processorExecutions)->toHaveCount(0);
    });

    test('loads multiple processor executions', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $documentJob = DocumentJob::factory()
            ->for($document)
            ->for($this->campaign)
            ->create();

        $processor1 = Processor::factory()->create(['slug' => 'ocr']);
        $processor2 = Processor::factory()->create(['slug' => 'classifier']);
        $processor3 = Processor::factory()->create(['slug' => 'extractor']);

        ProcessorExecution::factory()->for($documentJob)->for($processor1)->create();
        ProcessorExecution::factory()->for($documentJob)->for($processor2)->create();
        ProcessorExecution::factory()->for($documentJob)->for($processor3)->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result->documentJob->processorExecutions)->toHaveCount(3);
    });

    test('performs efficient eager loading with single query', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $documentJob = DocumentJob::factory()
            ->for($document)
            ->for($this->campaign)
            ->create();

        $processor = Processor::factory()->create();

        ProcessorExecution::factory()
            ->for($documentJob)
            ->for($processor)
            ->count(3)
            ->create();

        \DB::enableQueryLog();

        $action = new GetDocumentStatus;
        $action->handle($document);

        $queries = \DB::getQueryLog();

        // Should use minimal queries due to eager loading
        expect(count($queries))->toBeLessThan(5);

        \DB::disableQueryLog();
    });

    test('returns same document instance with loaded relationships', function () {
        $document = Document::factory()
            ->for($this->campaign)
            ->create();

        $action = new GetDocumentStatus;
        $result = $action->handle($document);

        expect($result)->toBe($document);
    });
});
